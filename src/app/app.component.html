<div class="app-container">
  <!-- Header -->
  <header class="app-header">
    <h1>图片裁剪工具</h1>
    <a href="https://github.com/xylplm/angular-image-cropper" target="_blank" rel="noopener noreferrer" class="repo-link" title="访问 GitHub 仓库">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v 3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
      </svg>
    </a>
  </header>

  <!-- Main Content -->
  <main class="app-main">
    <!-- Input Section -->
    <section class="card upload-section">
      <h2>上传图片</h2>
      <div class="upload-controls">
        <input 
          [ngModel]="imageURL()" 
          (ngModelChange)="imageURL.set($event)" 
          placeholder="输入图片 URL" 
          type="text"
          class="url-input" 
        />
        <label class="file-input-label">
          <input type="file" (change)="fileChangeEvent($event)" accept="image/*" />
          <span>选择文件</span>
        </label>
      </div>
    </section>

    <div class="content-wrapper">
      <!-- Cropper & Controls Together -->
      <div class="cropper-and-controls">
        <!-- Cropper Preview -->
        <div class="cropper-section">
          @if (!showCropper()) {
            <div class="placeholder-wrapper">
              <div class="placeholder-content">
                <div class="placeholder-icon">🖼️</div>
                <p class="placeholder-text">请上传或输入图片 URL</p>
                <p class="placeholder-hint">支持拖拽上传</p>
              </div>
            </div>
          }
          <div [style.display]="showCropper() ? null : 'none'" class="cropper-wrapper">
            <image-cropper
              [imageChangedEvent]="imageChangedEvent()"
              [imageURL]="imageURL()"
              [hidden]="hidden()"
              [disabled]="disabled()"
              [alignImage]="alignImage()"
              [roundCropper]="roundCropper()"
              [backgroundColor]="backgroundColor()"
              imageAltText="图片预览"
              [allowMoveImage]="allowMoveImage()"
              [hideResizeSquares]="hideResizeSquares()"
              [canvasRotation]="canvasRotation()"
              [aspectRatio]="aspectRatio()"
              [containWithinAspectRatio]="containWithinAspectRatio()"
              [maintainAspectRatio]="maintainAspectRatio()"
              [cropperStaticWidth]="cropperStaticWidth()"
              [cropperStaticHeight]="cropperStaticHeight()"
              [cropperMinWidth]="cropperMinWidth()"
              [cropperMinHeight]="cropperMinHeight()"
              [cropperMaxWidth]="cropperMaxWidth()"
              [cropperMaxHeight]="cropperMaxHeight()"
              [resizeToWidth]="resizeToWidth()"
              [resizeToHeight]="resizeToHeight()"
              [resetCropOnAspectRatioChange]="resetCropOnAspectRatioChange()"
              [cropper]="cropper()"
              (cropperChange)="cropper.set($event)"
              [transform]="transform()"
              (transformChange)="updateTransform($event)"
              [onlyScaleDown]="true"
              output="blob"
              format="png"
              (imageCropped)="imageCropped($event)"
              (imageLoaded)="imageLoaded()"
              (cropperReady)="cropperReady($event)"
              (loadImageFailed)="loadImageFailed()"
            ></image-cropper>
            @if (loading()) {
              <div class="loader">加载中...</div>
            }
          </div>
        </div>

        <!-- Controls Panel -->
        <aside class="controls-panel">
          <!-- Aspect Ratio -->
          <section class="card control-card">
            <h3>长宽比</h3>
            <div class="button-group compact">
              <button (click)="toggleMaintainAspectRatio()" [class.active]="maintainAspectRatio()" title="保持比例">
                锁定
              </button>
              <button (click)="toggleAspectRatio()" [class.active]="maintainAspectRatio() || containWithinAspectRatio()" title="切换比例">
                {{aspectRatioDisplay()}}
              </button>
              <button (click)="toggleContainWithinAspectRatio()" [class.active]="containWithinAspectRatio()" title="填充比例">
                填充
              </button>
            </div>
          </section>

          <!-- Rotation -->
          <section class="card control-card">
            <h3>旋转</h3>
            <div class="input-row">
              <input 
                id="rotation"
                [ngModel]="transform().rotate!" 
                placeholder="°" 
                type="number" 
                (ngModelChange)="updateRotation($event)" 
              />
            </div>
            <div class="button-group compact">
              <button (click)="rotateLeft()" title="左旋">↺</button>
              <button (click)="rotateRight()" title="右旋">↻</button>
            </div>
          </section>

          <!-- Flip -->
          <section class="card control-card">
            <h3>翻转</h3>
            <div class="button-group compact">
              <button (click)="flipHorizontal()" [class.active]="transform().flipH" title="水平翻转">⟷</button>
              <button (click)="flipVertical()" [class.active]="transform().flipV" title="垂直翻转">⇅</button>
            </div>
          </section>

          <!-- Zoom -->
          <section class="card control-card">
            <h3>缩放</h3>
            <div class="button-group compact">
              <button (click)="zoomOut()" title="缩小">−</button>
              <button (click)="zoomIn()" title="放大">+</button>
            </div>
          </section>

          <!-- Move -->
          <section class="card control-card">
            <h3>移动</h3>
            <div class="direction-pad">
              <button class="up" (click)="moveUp()" title="上移">↑</button>
              <button class="left" (click)="moveLeft()" title="左移">←</button>
              <button class="down" (click)="moveDown()" title="下移">↓</button>
              <button class="right" (click)="moveRight()" title="右移">→</button>
            </div>
          </section>

          <!-- Quick Settings -->
          <section class="card control-card">
            <h3>选项</h3>
            <div class="button-group compact">
              <button (click)="toggleAllowMoveImage()" [class.active]="allowMoveImage()" title="启用图片拖拽">拖拽</button>
              <button (click)="toggleDisabled()" [class.active]="disabled()" title="禁用裁剪">锁定</button>
              <button (click)="toggleHideResizeSquares()" [class.active]="hideResizeSquares()" title="隐藏调整点">隐藏</button>
            </div>
          </section>

          <!-- Size Settings (Collapsed) -->
          <details class="card control-card">
            <summary><h3>尺寸设置</h3></summary>
            <div class="form-grid compact-grid">
              <div class="form-group">
                <label for="cropperStaticWidth">固定宽</label>
                <input id="cropperStaticWidth" type="number" (keyup)="debounce($event)" />
              </div>
              <div class="form-group">
                <label for="cropperStaticHeight">固定高</label>
                <input id="cropperStaticHeight" type="number" (keyup)="debounce($event)" />
              </div>
              <div class="form-group">
                <label for="cropperMinWidth">最小宽</label>
                <input id="cropperMinWidth" type="number" (keyup)="debounce($event)"/>
              </div>
              <div class="form-group">
                <label for="cropperMinHeight">最小高</label>
                <input id="cropperMinHeight" type="number" (keyup)="debounce($event)"/>
              </div>
              <div class="form-group">
                <label for="cropperMaxWidth">最大宽</label>
                <input id="cropperMaxWidth" type="number" (keyup)="debounce($event)"/>
              </div>
              <div class="form-group">
                <label for="cropperMaxHeight">最大高</label>
                <input id="cropperMaxHeight" type="number" (keyup)="debounce($event)"/>
              </div>
              <div class="form-group">
                <label for="resizeToWidth">输出宽</label>
                <input id="resizeToWidth" type="number" (keyup)="debounce($event)"/>
              </div>
              <div class="form-group">
                <label for="resizeToHeight">输出高</label>
                <input id="resizeToHeight" type="number" (keyup)="debounce($event)"/>
              </div>
            </div>
          </details>

          <!-- Advanced Settings (Collapsed) -->
          <details class="card control-card">
            <summary><h3>高级</h3></summary>
            <div class="button-group compact">
              <button (click)="toggleBackgroundColor()" style="color:white" [style.background-color]="backgroundColor()" title="更改背景">背景</button>
              <button (click)="toggleResetCropOnAspectRatioChange()" [class.active]="resetCropOnAspectRatioChange()" title="比例变化时重置">重置</button>
              <button (click)="toggleHidden()" [class.hidden]="maintainAspectRatio()" title="隐藏裁剪器">隐藏</button>
            </div>
            <div class="button-group compact">
              <button (click)="test()" class="secondary-btn" title="随机测试">测试</button>
              <button (click)="resetImage()" class="secondary-btn" title="重置图片">复位</button>
            </div>
          </details>
        </aside>
      </div>
    </div>

    <!-- Cropped Image Preview -->
    <section class="card result-section">
      <h2>裁剪结果</h2>
      @if (!croppedImage()) {
        <div class="result-placeholder">
          <div class="placeholder-content">
            <div class="placeholder-icon">✨</div>
            <p class="placeholder-text">完成裁剪后在此显示</p>
          </div>
        </div>
      }
      <div [style.display]="croppedImage() ? null : 'none'" class="result-preview">
        <img [src]="croppedImage()" [style.border]="croppedImage() ? '2px solid #007bff' : 'none'" alt="裁剪预览" />
      </div>
    </section>
  </main>
</div>
